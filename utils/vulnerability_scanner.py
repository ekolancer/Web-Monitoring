import aiohttp
import asyncio
from utils.security_headers import check_security_headers_async

async def check_vulnerabilities(domain: str) -> dict:
    """Advanced vulnerability scanning"""
    vulnerabilities = []

    try:
        async with aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=10)) as session:
            # Check for common vulnerabilities

            # 1. Check for outdated software headers
            async with session.get(f"http://{domain}") as response:
                server = response.headers.get('Server', '')
                if 'apache/2.2' in server.lower() or 'nginx/1.10' in server.lower():
                    vulnerabilities.append({
                        'type': 'Outdated Software',
                        'severity': 'High',
                        'description': f'Outdated server software detected: {server}'
                    })

            # 2. Check for missing security headers
            headers_check = await check_security_headers_async(domain)
            if headers_check['status'] == 'WARN':
                vulnerabilities.append({
                    'type': 'Missing Security Headers',
                    'severity': 'Medium',
                    'description': headers_check['detail']
                })

            # 3. Check for directory listing
            async with session.get(f"http://{domain}/backup/") as response:
                if response.status == 200 and 'index of' in (await response.text()).lower():
                    vulnerabilities.append({
                        'type': 'Directory Listing',
                        'severity': 'High',
                        'description': 'Directory listing enabled on /backup/'
                    })

    except Exception as e:
        return {
            'check_type': 'Vulnerability Scan',
            'status': 'ERROR',
            'severity': 'Unknown',
            'detail': f'Scan failed: {str(e)}'
        }

    if vulnerabilities:
        return {
            'check_type': 'Vulnerability Scan',
            'status': 'CRITICAL',
            'severity': 'High',
            'detail': f'Found {len(vulnerabilities)} vulnerabilities',
            'vulnerabilities': vulnerabilities
        }

    return {
        'check_type': 'Vulnerability Scan',
        'status': 'OK',
        'severity': 'Low',
        'detail': 'No critical vulnerabilities detected'
    }

async def check_ssl_vulnerabilities(domain: str) -> dict:
    """Check for SSL/TLS vulnerabilities"""
    try:
        # Check SSL version support
        import ssl
        import socket

        context = ssl.create_default_context()
        context.check_hostname = False
        context.verify_mode = ssl.CERT_NONE

        with socket.create_connection((domain, 443)) as sock:
            with context.wrap_socket(sock, server_hostname=domain) as ssock:
                version = ssock.version()
                if version in ['TLSv1', 'TLSv1.1']:
                    return {
                        'check_type': 'SSL Vulnerabilities',
                        'status': 'CRITICAL',
                        'severity': 'Critical',
                        'detail': f'Insecure SSL version: {version}'
                    }

    except Exception as e:
        return {
            'check_type': 'SSL Vulnerabilities',
            'status': 'ERROR',
            'severity': 'Unknown',
            'detail': f'SSL check failed: {str(e)}'
        }

    return {
        'check_type': 'SSL Vulnerabilities',
        'status': 'OK',
        'severity': 'Low',
        'detail': 'SSL configuration appears secure'
    }